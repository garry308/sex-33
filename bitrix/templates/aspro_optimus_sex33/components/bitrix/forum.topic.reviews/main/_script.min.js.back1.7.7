!function(m){m.FTRList=function(e){if(this.id="FTRList"+e.form.id,this.mess={},this.form=e.form,e.id)for(var t=0;t<e.id.length;t++)this.bind(e.id[t]);this.params={preorder:"Y"==e.preorder,pageNumber:e.pageNumber,pageCount:e.pageCount},BX.addCustomEvent(this.form,"onAdd",BX.delegate(this.add,this)),BX.addCustomEvent(this.form,"onRequest",BX.delegate(function(){if(void 0!==this.params.pageNumber){var e=BX.findChild(this.form,{attr:{name:"pageNumber"}});e||(e=BX.create("input",{props:{type:"hidden",name:"pageNumber"}}),this.form.appendChild(e)),e.value=this.params.pageNumber}if(void 0!==this.params.pageCount){var t=BX.findChild(this.form,{attr:{name:"pageCount"}});t||(t=BX.create("input",{props:{type:"hidden",name:"pageCount"}}),this.form.appendChild(t)),t.value=this.params.pageCount}},this)),BX.addCustomEvent(this.form,"onResponse",BX.delegate(function(){var e=BX.findChild(this.form,{attr:{name:"pageNumber"}},!0);e&&BX.remove(e)},this))},m.FTRList.prototype={add:function(e,t){var i,s=BX(this.form.id+"container"),r={className:/reviews-reply-form|reviews-collapse/},a=m.fTextToNode(t.message);if(s||(s=BX.create("div",{attrs:{id:this.form.id+"container"},props:{className:"reviews-block-container reviews-reviews-block-container"},children:[BX.create("div",{props:{className:"reviews-block-outer"},children:[BX.create("div",{props:{className:"reviews-block-inner"}})]})]}),m.fReplaceOrInsertNode(s,null,BX.findChild(document,r,!0).parentNode,r),s=BX(this.form.id+"container")),i=s?BX.findChild(s,{className:"reviews-block-inner"},!0):null,a&&i){if(t.allMessages){if(m.fReplaceOrInsertNode(a,i,BX.findChild(document,r,!0).parentNode,r),t.navigation&&t.pageNumber){var o,n=m.fTextToNode(t.navigation),d=n?BX.findChildren(s.parentNode,{className:"reviews-navigation-box"},!0):null;if(n){if(!d){s.parentNode.insertBefore(BX.create("div",{props:{className:"reviews-navigation-box reviews-navigation-top"}}),s);for(var l=s;(l=l.nextSibling)&&1!=l.nodeType;);var h=BX.create("div",{props:{className:"reviews-navigation-box reviews-navigation-bottom"}});l?s.parentNode.insertBefore(h,l):s.parentNode.appendChild(h),d=BX.findChildren(s.parentNode,{className:"reviews-navigation-box"},!0)}for(o=0;o<d.length;o++)d[o].innerHTML=n.innerHTML}this.params.pageNumber=t.pageNumber,this.params.pageCount=t.pageCount}if(t.messagesID&&"object"==typeof t.messagesID)for(var c=0;c<t.messagesID.length;c++)t.messagesID[c]!=e&&this.bind(t.messagesID[c])}else void 0!==t.message&&(this.params.preorder?i.appendChild(a):i.insertBefore(a,i.firstChild));m.fRunScripts(t.message),this.bind(e)}},bind:function(t){var e=BX("message"+t);if(e){this.mess["m"+t]={node:e,author:{id:e.getAttribute("bx-author-id"),name:e.getAttribute("bx-author-name")}};var i=BX.findChildren(e,{tagName:"A",className:"reviews-button-small"},!0),s=BX.delegate(function(){var e=BX.proxy_context;this.act(e.getAttribute("bx-act"),t)},this),r=BX.delegate(function(){this.act("reply",t)},this),a=BX.delegate(function(){this.act("quote",t)},this);if(i&&0<i.length)for(var o=0;o<i.length;o++)"moderate"==i[o].getAttribute("bx-act")||"del"==i[o].getAttribute("bx-act")?BX.adjust(i[o],{events:{click:s},attrs:{"bx-href":i[o].getAttribute("href"),href:"javascript:void(0);"}}):this.form&&("reply"==i[o].getAttribute("bx-act")?BX.bind(i[o],"click",r):"quote"==i[o].getAttribute("bx-act")&&BX.bind(i[o],"mousedown",a))}},act:function(a,e){if(e&&this.mess["m"+e])if("quote"==a){var t=m.GetSelection();if(document.getSelection&&(t=(t=t.replace(/\r\n\r\n/gi,"_newstringhere_").replace(/\r\n/gi," ")).replace(/  /gi,"").replace(/_newstringhere_/gi,"\r\n\r\n")),""===t&&0<e&&BX("message_text_"+e,!0)){var i=BX("message_text_"+e,!0);"object"==typeof i&&i&&(t=i.innerHTML)}t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/[\n|\r]*<br(\s)*(\/)*>/gi,"\n")).replace(/<script[^>]*>/gi,"").replace(/<\/script[^>]*>/gi,"")).replace(/\001([^\002]*)\002/gi,function(e,t){var i=" ",s=/showWMVPlayer.*?bx_wmv_player.*?file:[\s'"]*([^"']*).*?width:[\s'"]*([^"']*).*?height:[\s'"]*([^'"]*).*?/gi.exec(t);s&&(i="[VIDEO WIDTH="+s[2]+" HEIGHT="+s[3]+"]"+s[1]+"[/VIDEO]")," "==i&&(s=/bxPlayerOnload[\s\S]*?[\s'"]*file[\s'"]*:[\s'"]*([^"']*)[\s\S]*?[\s'"]*height[\s'"]*:[\s'"]*([^"']*)[\s\S]*?[\s'"]*width[\s'"]*:[\s'"]*([^"']*)/gi.exec(t))&&(i="[VIDEO WIDTH="+s[3]+" HEIGHT="+s[2]+"]"+s[1]+"[/VIDEO]");return i})).replace(/<noscript[^>]*>/gi,"").replace(/<\/noscript[^>]*>/gi,"")).replace(/\003([^\004]*)\004/gi," ")).replace(/<table class\=[\"]*forum-quote[\"]*>[^<]*<thead>[^<]*<tr>[^<]*<th>([^<]+)<\/th><\/tr><\/thead>[^<]*<tbody>[^<]*<tr>[^<]*<td>/gi,"")).replace(/<table class\=[\"]*forum-code[\"]*>[^<]*<thead>[^<]*<tr>[^<]*<th>([^<]+)<\/th><\/tr><\/thead>[^<]*<tbody>[^<]*<tr>[^<]*<td>/gi,"")).replace(/<table class\=[\"]*data-table[\"]*>[^<]*<tbody>/gi,"")).replace(/<\/td>[^<]*<\/tr>(<\/tbody>)*<\/table>/gi,"")).replace(/[\r|\n]{2,}([\001|\002])/gi,"\n$1");for(var s=0;s++<50&&(0<=t.search(/\002([^\002\003]*)\003/gi)||0<=t.search(/\001([^\001\003]*)\003/gi));)t=t.replace(/\002([^\002\003]*)\003/gi,"[CODE]$1[/CODE]").replace(/\001([^\001\003]*)\003/gi,"[QUOTE]$1[/QUOTE]");var r=function(e,t,i){for(var s=new RegExp("([^]*)("+t+")([^]*)","i"),r=new RegExp("((?:)(?:[^]*))("+t+")((?:[^]*)(?:))","i"),a=0;a++<300&&0<=e.search(s);)e=e.replace(r,"$1"+i+"$3");return e};for(s=0;s++<10&&0<=t.search(/\004([^\004\003]*)\003/gi);)t=(t=r(t=r(t=r(t=r(t,"<tr>","[TR]"),"</tr>","[/TR]"),"<td>","[TD]"),"</td>","[/TD]")).replace(/\004([^\004\003]*)\003/gi,"[TABLE]$1[/TD][/TR][/TABLE]");t=(t=(t=(t=(t=(t=(t=BX.browser.IsIE()?t.replace(/<img(?:(?:\s+alt\s*=\s*\"?smile([^\"\s]+)\"?)|(?:\s+\w+\s*=\s*[^\s>]*))*>/gi,"$1"):t.replace(/<img.*?alt=[\"]*smile([^\"\s]+)[\"]*[^>]*>/gi,"$1")).replace(/<a[^>]+href=[\"]([^\"]+)\"[^>]+>([^<]+)<\/a>/gi,"[URL=$1]$2[/URL]")).replace(/<a[^>]+href=[\']([^\']+)\'[^>]+>([^<]+)<\/a>/gi,"[URL=$1]$2[/URL]")).replace(/<[^>]+>/gi," ").replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&quot;/gi,'"')).replace(/(smile(?=[:;8]))/g,"")).replace(/\&shy;/gi,"")).replace(/\&nbsp;/gi," "),BX.onCustomEvent(this.form,"onQuote",[{author:this.mess["m"+e].author,id:e,text:t}])}else if("reply"==a)BX.onCustomEvent(this.form,"onReply",[{author:this.mess["m"+e].author,id:e}]);else if("del"!=a||confirm(BX.message("f_cdm"))){if("moderate"==a||"del"==a){var o=BX.proxy_context,n=o.getAttribute("bx-href").replace(/.AJAX_CALL=Y/g,"").replace(/.sessid=[^&]*/g,""),d=BX.findParent(o,{tag:"table"}),l=BX.create("a",{attrs:{className:"reply-action-note"}}),h=function(){BX.remove(l),BX.show(o.parentNode)};BX.hide(o.parentNode),l.innerHTML=BX.message("f_wait"),o.parentNode.parentNode.appendChild(l),BX.ajax.loadJSON(n,{AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},BX.delegate(function(e){if(e.status&&d)if(BX.onCustomEvent(m,"onForumCommentAJAXAction",[a]),"del"==a){var t=m.curpage||top.window.location.href;BX.fx.hide(d,"scroll",{time:.15,callback_complete:BX.delegate(function(){BX.remove(d),h();var e=BX.findChild(BX(this.form.id+"container"),{class:"reviews-post-table"},!0,!0);(!e||e.length<1)&&1<this.params.pageNumber&&BX.reload(t)},this)})}else{var i=BX.hasClass(d,"reviews-post-hidden"),s=i?BX.message("f_hide"):BX.message("f_show"),r=BX.findChild(d,{className:"reviews-text"},!0);BX.fx.hide(r,"fade",{time:.1,callback_complete:function(){BX.toggleClass(d,"reviews-post-hidden"),o.innerHTML=s,n=n.replace(new RegExp("REVIEW_ACTION="+(i?"SHOW":"HIDE")),"REVIEW_ACTION="+(i?"HIDE":"SHOW")),o.setAttribute("bx-href",n),BX.fx.show(r,"fade",{time:.1}),h(),BX.style(r,"background-color",i?"#FFFFFF":"#E5F8E3")}})}else BX.addClass(l,"error"),l.innerHTML='<span class="errortext">'+e.message+"</span>"},this))}}else BX.DoNothing();else BX.DoNothing();return!1}},m.FTRForm=function(e){this.id="FTRForm"+e.form.id,this.form=e.form,this.editorName=e.editorName,this.editorId=e.editorId,this.editor=m[e.editorName],this.windowEvents={},this.editor?this.addParsers(this.editor):(this.windowEvents.LHE_OnInit=BX.delegate(function(e){e.id==this.editorId&&(this.addParsers(e),this.editor=e)},this),this.windowEvents.LHE_ConstructorInited=BX.delegate(function(e){e.id==this.editorId&&(this.editor||(this.addParsers(e),this.editor=e),this.editor.ucInited=!0)},this),BX.addCustomEvent(m,"LHE_OnInit",this.windowEvents.LHE_OnInit),BX.addCustomEvent(m,"LHE_ConstructorInited",this.windowEvents.LHE_ConstructorInited)),this.params={messageMax:64e3},BX.addCustomEvent(this.form,"onQuote",BX.delegate(function(e){this.show(),this.paste(e,"QUOTE")},this)),BX.addCustomEvent(this.form,"onReply",BX.delegate(function(e){this.show(),this.paste(e,"REPLY")},this))},m.FTRForm.prototype={addParsers:function(e){e.AddParser({name:"postuser",obj:{Parse:function(e,t,s){return t=t.replace(/\[USER\s*=\s*(\d+)\]((?:\s|\S)*?)\[\/USER\]/gi,function(e,t,i){return t=parseInt(t),i=BX.util.trim(i),'<span id="'+s.SetBxTag(!1,{tag:"postuser",params:{value:t}})+'" style="color: #2067B0; border-bottom: 1px dashed #2067B0;">'+i+"</span>"})},UnParse:function(e,t,i){if("postuser"==e.tag){for(var s="",r=0;r<t.arNodes.length;r++)s+=i._RecursiveGetHTML(t.arNodes[r]);return s=BX.util.trim(s),"[USER="+e.params.value+"]"+s+"[/USER]"}return""}}})},validate:function(e){var t=this.form,i="",s=t.REVIEW_TEXT.value.length;if(t.BXFormSubmit_save)return!0;if(t.TITLE&&t.TITLE.value.length<2&&(i+=BX.message("no_topic_name")),s<2?i+=BX.message("no_message"):0!==this.params.messageMax&&s>this.params.messageMax&&(i+=BX.message("max_len").replace(/\#MAX_LENGTH\#/gi,this.params.messageMax).replace(/\#LENGTH\#/gi,s)),""!==i)return alert(i),!1;var r=BX.findChild(t,{attribute:{name:"send_button"}},!0);r&&(r.disabled=!0);var a=BX.findChild(t,{attribute:{name:"view_button"}},!0);return a&&(a.disabled=!0),"Y"!=e||(BX.onCustomEvent(m,"onBeforeForumCommentAJAXPost",[t]),BX.onCustomEvent(this.form,"onRequest",[this,e]),setTimeout(BX.delegate(function(){if(!m.renderRecaptchaById||!m.asproRecaptcha||!m.asproRecaptcha.key)return BX.ajax.submit(t,BX.delegate(this.get,this)),!0;"invisible"==m.asproRecaptcha.params.recaptchaSize&&"undefined"!=typeof grecaptcha?$(t).find(".g-recaptcha-response").val()?BX.ajax.submit(t,BX.delegate(this.get,this)):grecaptcha.execute($(t).find(".g-recaptcha").data("widgetid")):BX.ajax.submit(t,BX.delegate(this.get,this))},this),50),!1)},get:function(){this.form.BXFormSubmit_save=null;var e=m.forumAjaxPostTmp;if(m.curpage=m.curpage||top.window.location.href,BX.onCustomEvent(m,"onForumCommentAJAXPost",[e,this.form]),void 0===e||e.reload)BX.reload(m.curpage);else{if(e.status){if(e.allMessages||void 0!==e.message)BX.onCustomEvent(this.form,"onAdd",[e.messageID,e]),this.clear();else if(e.previewMessage){var t=BX.findChild(document,{className:"reviews-preview"},!0),i=BX.findChild(document,{className:/reviews-reply-form|reviews-collapse/},!0).parentNode,s=m.fTextToNode(e.previewMessage);m.fReplaceOrInsertNode(s,t,i,{className:/reviews-reply-form|reviews-collapse/}),m.PostFormAjaxStatus(""),m.fRunScripts(e.previewMessage)}var r=e.messageID?BX("message"+e.messageID):null;r&&BX.scrollToNode(r)}for(var a=this.form.getElementsByTagName("input"),o=0;o<a.length;o++){var n=a[o];"submit"==n.getAttribute("type")&&(n.disabled=!1)}e.statusMessage&&m.PostFormAjaxStatus(e.statusMessage),BX.onCustomEvent(this.form,"onResponse",[e,this.form]),BX.onCustomEvent(m,"onAfterForumCommentAJAXPost",[e,this.form])}},clear:function(){if(this.editor.ReInit(""),this.editor.fAutosave&&BX.bind(this.editor.pEditorDocument,"keydown",BX.proxy(this.editor.fAutosave.Init,this.editor.fAutosave)),BX.type.isDomNode(this.form)){var e=BX.findChild(document,{className:"reviews-preview"},!0);e&&BX.remove(e);for(var t,i,s,r=0;(t=BX("upload_files_"+r+++"_"+this.form.index.value))&&t;)(i=BX.findChild(t,{tag:"input"}))&&s&&((s=BX.clone(i)).value="",i.parentNode.insertBefore(s,i),i.parentNode.removeChild(i)),BX.hide(t);var a=BX.findChild(this.form,{className:"forum-upload-file-attach"},!0);a&&BX.show(a);var o=BX.findChild(this.form,{className:"reviews-upload-info"},!0);o&&BX.hide(o);var n=null,d=BX.findChild(this.form,{attr:{name:"captcha_code"}},!0),l=BX.findChild(this.form,{attr:{name:"captcha_word"}},!0),h=BX.findChild(this.form,{className:"reviews-reply-field-captcha-image"},!0);h&&(n=BX.findChild(h,{tag:"img"})),d&&l&&n&&(l.value="",BX.ajax.getCaptcha(function(e){d.value=e.captcha_sid,n.src="/bitrix/tools/captcha.php?captcha_code="+e.captcha_sid}))}},show:function(){return BX.onCustomEvent(this.form,"onBeforeShow",[this]),BX.show(this.form.parentNode),BX.scrollToNode(BX.findChild(this.form,{attribute:{name:"send_button"}},!0)),setTimeout(BX.delegate(function(){this.editor.SetFocus(),BX.defer(this.editor.SetFocus,this.editor)()},this),100),BX.onCustomEvent(this.form,"onAfterShow",[this]),!1},hide:function(){return BX.onCustomEvent(this.form,"onBeforeHide",[this]),BX.hide(this.form.parentNode),BX.onCustomEvent(this.form,"onAfterHide",[this]),!1},transverse:function(){return"none"==this.form.parentNode.style.display?this.show():this.hide(),!1},paste:function(e,t){BX.onCustomEvent(this.form,"onPaste",[e,t,this]);var i=e.author?e.author:"",s=e.text?e.text:"",r=e.id?e.id:"";i?"code"==this.editor.sEditorMode&&this.editor.bBBCode?i=0<i.id?"[USER="+i.id+"]"+i.name+"[/USER]":i.name:"html"==this.editor.sEditorMode&&(i.name=i.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;"),i=0<i.id?'<span id="'+this.editor.SetBxTag(!1,{tag:"postuser",params:{value:i.id}})+'" style="color: #2067B0; border-bottom: 1px dashed #2067B0;">'+i.name+"</span>":"<span>"+i.name+"</span>"):i="","QUOTE"==t?"code"==this.editor.sEditorMode&&this.editor.bBBCode?this.editor.WrapWith("[QUOTE"+(0<r?" ID="+r:"")+"]","[/QUOTE]",(""!==i?i+BX.message("f_author")+"\n":"")+s):"html"==this.editor.sEditorMode&&this.editor.InsertHTML('<blockquote class="bx-quote" id="mess'+r+'">'+(""!==i?i+BX.message("f_author")+"<br/>":"")+this.editor.ParseContent(s,!0)+"</blockquote><br/>"):(s=(i?i+", ":"")+this.editor.ParseContent(s,!0),"code"==this.editor.sEditorMode&&this.editor.bBBCode?this.editor.WrapWith("","",s):"html"==this.editor.sEditorMode&&this.editor.InsertHTML(s)),this.editor.SetFocus(),BX.defer(this.editor.SetFocus,this.editor)()}},BX.ready(function(){if(BX.browser.IsIE()){var e,t,i,s=BX.findChildren(document,{className:"reviews-post-table"},!0);if(!s)return;for(e=0;e<s.length;e++)for(i=(t=s[e].getElementsByTagName("*")).length;i--;)t[i].scrollWidth>t[i].offsetWidth&&(t[i].style.paddingBottom="20px",t[i].style.overflowY="hidden")}}),m.fTextToNode=function(e){var t=BX.create("div");return t.innerHTML=e,0<t.childNodes.length?t:null},m.PostFormAjaxStatus=function(e){var t,i=BX.findChild(document,{className:"reviews-note-box"},!0,!0);if(i)for(t=0;t<=i.length;t++)BX.remove(i[t]);var s=BX.findChild(document,{className:"reviews-block-container"},!0);if(s&&!(e.length<1)){var r=m.fTextToNode(e);if(r)for(var a=["reviews-reply-form","reviews-collapse"],o=s;(o=o.nextSibling)&&o;)if(1==o.nodeType){var n=!1;for(t=0;t<a.length;t++)if(BX.hasClass(o,a[t])){n=!0;break}if(n){o.parentNode.insertBefore(r,o);break}}}},m.SetReviewsAjaxPostTmp=function(e){m.forumAjaxPostTmp=e},m.fReplaceOrInsertNode=function(e,t,i,s){var r=null;return!!BX.type.isDomNode(i)&&(!(!BX.type.isDomNode(e)&&!BX.type.isArray(e)&&0<e.length&&!(e=m.fTextToNode(e)))&&(BX.type.isDomNode(t)&&(i=t.parentNode,r=t.nextSibling,i.removeChild(t)),r||(r=BX.findChild(i,s,!0)),r?r.parentNode.insertBefore(e,r):i.appendChild(e),!0))},m.fRunScripts=function(e){var t=BX.processHTML(e,!0);BX.ajax.processScripts(t.SCRIPT,!0)},m.ShowLastEditReason=function(e,t){t&&(t.style.display=e?"block":"none")},m.AttachFile=function(e,t,i,s){var r=null,a=!1;e=parseInt(e),t=parseInt(t),document.getElementById("upload_files_info_"+i).style.display="block";for(var o=e;o<e+t&&((r=document.getElementById("upload_files_"+o+"_"+i))&&null!==typeof r);o++)if("none"==r.style.display){a=!0,r.style.display="block";break}!0===(!a||e+t-1<=o)&&(s.style.display="none")},m.GetSelection=function(){var e="";return m.getSelection?e=m.getSelection().toString():document.selection&&(e=document.selection.createRange().text),e}}(window);